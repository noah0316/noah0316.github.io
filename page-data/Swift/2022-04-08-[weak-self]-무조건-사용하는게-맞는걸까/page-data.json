{"componentChunkName":"component---src-templates-blog-post-js","path":"/Swift/2022-04-08-[weak-self]-무조건-사용하는게-맞는걸까/","result":{"data":{"site":{"siteMetadata":{"title":"Noah's Dev Log","author":"[SeungHyun]","siteUrl":"https://noah0316.github.io","comment":{"disqusShortName":"","utterances":"noah0316/noah0316.github.io"},"sponsor":{"buyMeACoffeeId":"noah0316"}}},"markdownRemark":{"id":"61881892-077e-58b1-b2ca-c0bf497615f1","excerpt":"클로져에서 self를 캡쳐할 때  를 사용하는 경우는 순환 참조를 방지하기 위해 약한 참조로 클로져 내부에서 해당 클래스의 인스턴스를 사용할때 입니다. 클로져에서 약한 참조를 이용해 특정 인스턴스를 캡쳐하지 않으면 (여기서는 self를 캡쳐한다고 가정) self가 해제될 때까지 기다리고 self는 클로져가 해제될 때까지 기다리는 strong reference cycle…","html":"<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 33.74233128834356%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABaklEQVQoz12R60/CMBTF978bFRD9ZkJClPhMnBgfiU8Qjc8IBCWoH4gBjYCBrWPtGLix7bheAiacpO1y++tZ76mCUM6vA8YYOOcwDIOG67hyC0EQ0JDyPA+6rkMIQUy324U39CaclCIny7bAdEaQNJbfXHBMa+AMoHU0mF1zwvXs3mRfmiqXlQts3KbwUL2DsAQsYeGlVoJa2MbxyyHEQMAPfOQqGeIeq/fUCTcFyvVnqPmQKx+B90cXUOJ7EUQ357B0sICvn09qJ3G6jMXdGObVGVS+y+iINqLpWcS25rG4H0VTa6A/6CN5kUBcjSCWnkOxlh8ZZl7PkLpO4uo9C53pdMPCxxPWb1ax96TCtMOcfA/nlRPicm9Z2H0bvuejVC9i7WYl5HZg9NjIUIbcbDfIaCyZUavTCn+g0UHHcTDimtSuzF/mxU2OVlhjBps8jjIcDukQrb5PebmuSzUJUc3/r405aTjNSf0BjkoBhW4a9aoAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"1\" title=\"1\" src=\"/static/219f9ed045afd3755a65c5f70333e6f0/a6d36/1.png\" srcset=\"/static/219f9ed045afd3755a65c5f70333e6f0/222b7/1.png 163w,\n/static/219f9ed045afd3755a65c5f70333e6f0/ff46a/1.png 325w,\n/static/219f9ed045afd3755a65c5f70333e6f0/a6d36/1.png 650w,\n/static/219f9ed045afd3755a65c5f70333e6f0/e548f/1.png 975w,\n/static/219f9ed045afd3755a65c5f70333e6f0/3c492/1.png 1300w,\n/static/219f9ed045afd3755a65c5f70333e6f0/fa63f/1.png 2298w\" sizes=\"(max-width: 650px) 100vw, 650px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n</p>\n<p>클로져에서 self를 캡쳐할 때 <code class=\"language-text\">[weak self]</code> 를 사용하는 경우는 순환 참조를 방지하기 위해</p>\n<p>약한 참조로 클로져 내부에서 해당 클래스의 인스턴스를 사용할때 입니다.</p>\n<blockquote>\n<p>클로져에서 약한 참조를 이용해 특정 인스턴스를 캡쳐하지 않으면 (여기서는 self를 캡쳐한다고 가정)<br>\nself가 해제될 때까지 기다리고 self는 클로져가 해제될 때까지 기다리는 strong reference cycle<br>\n상황을 만들어 내게 됩니다. 이러한 상황을 해결하기 위해 사용하는 것이 <code class=\"language-text\">[weak self]</code>입니다.</p>\n</blockquote>\n<blockquote>\n<p>따라서 클로져에서 특정 인스턴스를 캡쳐할 때 약한 참조(ex. <code class=\"language-text\">[weak self]</code>)\n를 하는 이유는 Retain Cycle(순환 참조)로 인한 메모리 누수(memory leak)를 방지하기 위해 사용합니다.</p>\n</blockquote>\n<p>그동안 저는 클로져 내부에서 해당 클래스의 인스턴스를 사용할 때는 대부분 <code class=\"language-text\">[weak self]</code>를 이용해</p>\n<p>self를 캡쳐해 클로져 내부에서 해당 클래스의 인스턴스를 사용했었는데요,</p>\n<p>과연 클로져 내부에서 해당 클래스의 인스턴스를 캡쳐할 때</p>\n<p>모든 경우에 <code class=\"language-text\">[weak self]</code>를 이용한 약한 참조가 필요한지 이번 기회를 통해 같이 알아보도록 합시다.</p>\n<h2 id=\"그전에\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EC%A0%84%EC%97%90\" aria-label=\"그전에 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그전에..</h2>\n<h3 id=\"code-classlanguage-textunowned-selfcode-를-이용해-비-소유-참조를-하면-안-되나요🧐\" style=\"position:relative;\"><a href=\"#code-classlanguage-textunowned-selfcode-%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%B4-%EB%B9%84-%EC%86%8C%EC%9C%A0-%EC%B0%B8%EC%A1%B0%EB%A5%BC-%ED%95%98%EB%A9%B4-%EC%95%88-%EB%90%98%EB%82%98%EC%9A%94%F0%9F%A7%90\" aria-label=\"code classlanguage textunowned selfcode 를 이용해 비 소유 참조를 하면 안 되나요🧐 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">[unowned self]</code> 를 이용해 비 소유 참조를 하면 안 되나요?🧐</h3>\n<p><strong><code class=\"language-text\">unowned</code></strong>를 이용해 비 소유 참조를 하는 방식은 위와 같은 순환 참조를 피하기 위해 사용할 수 있는 방법 중 하나입니다.</p>\n<blockquote>\n<p>비 소유 참조를 하기 때문에 Reference Count를 증가시키지 않습니다.</p>\n</blockquote>\n<p>하지만 <strong><code class=\"language-text\">unowned</code></strong>은 값이 있음을 가정하고 사용하기 때문에 self를 <strong>강제로 unwrapping</strong>하고 <strong>할당이 해제된 후(deallocate)</strong>에도 <strong>내용에 액세스</strong>하려고 할 수 있기 때문에, <strong>unowned</strong>은 self의 생명주기를 고려하여 사용해야합니다.</p>\n<blockquote>\n<p><code class=\"language-text\">unowned</code>로 참조한 값이 nil인데 접근하려 한다면 runtime에 crash가 발생할 것입니다.</p>\n</blockquote>\n<p>따라서 완벽하게 self의 생명주기를 고려하지 않은 상황이라면</p>\n<p><strong><code class=\"language-text\">[weak self]</code></strong>를 이용해 안전한 방식으로 순환 참조를 피할 수 있게 하는 것이 좋을 것입니다.</p>\n<h2 id=\"3개의-예제를-보며-생각해봅시다\" style=\"position:relative;\"><a href=\"#3%EA%B0%9C%EC%9D%98-%EC%98%88%EC%A0%9C%EB%A5%BC-%EB%B3%B4%EB%A9%B0-%EC%83%9D%EA%B0%81%ED%95%B4%EB%B4%85%EC%8B%9C%EB%8B%A4\" aria-label=\"3개의 예제를 보며 생각해봅시다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3개의 예제를 보며 생각해봅시다.</h2>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> value<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">String</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* some logic here... */</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 1st example</span>\n        <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">map</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> value <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// 2nd example</span>\n        <span class=\"token builtin\">DispatchQueue</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">asyncAfter</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Any</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 3rd example</span>\n        handler <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> value <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Ant</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>첫 번째 예제는 map의 인자로 전달하는 클로져이고,</p>\n<p>두 번째 예제는 DispatchQueue.main.asyncAfter로 인자로 전달하는 클로져입니다.</p>\n<p>마지막으로 세 번째 예제는 프로퍼티에 저장되는 클로져입니다.(Stored in a property)</p>\n<blockquote>\n<p>일급함수 특성 이용\n일급함수에 대해 알아보고 싶으시다면 아래의 링크를 참조해주세요!<br>\n링크 : <a href=\"https://noah0316.github.io/Swift/2021-02-09-swift%EC%9D%98-%ED%95%A8%EC%88%98%EB%8A%94-%EC%9D%BC%EA%B8%89%ED%95%A8%EC%88%98%EC%9D%B8%EA%B0%80/\">Swift의 함수는 일급함수인가?</a></p>\n</blockquote>\n<p>세 가지 예제에서 실제로 <code class=\"language-text\">[weak self]</code> 필요하지 않을 수도 있지만 모두 <code class=\"language-text\">[weak self]</code>를 사용하고 있습니다.</p>\n<h3 id=\"생각해봅시다-🧐\" style=\"position:relative;\"><a href=\"#%EC%83%9D%EA%B0%81%ED%95%B4%EB%B4%85%EC%8B%9C%EB%8B%A4-%F0%9F%A7%90\" aria-label=\"생각해봅시다 🧐 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>생각해봅시다 🧐</h3>\n<p>시작하기 전에 몇 번 예제가 <code class=\"language-text\">[weak self]</code>를 정말 필요로 하는 예제일까요?</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> value<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">String</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* some logic here... */</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 1st example</span>\n        <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">map</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> value <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// 2nd example</span>\n        <span class=\"token builtin\">DispatchQueue</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">asyncAfter</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Any</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 3rd example</span>\n        handler <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> value <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Ant</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그리고, 몇 번 예제가 <code class=\"language-text\">[weak self]</code>를 쓸 필요가 없을까요?</p>\n<blockquote>\n<p>이미 다 알고 계신다면 이번 게시글은 Skip 하시는 걸로…!!</p>\n</blockquote>\n<p>1번 예제부터 시작해봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> value<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">String</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* some logic here... */</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 1st example</span>\n        <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">map</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> value <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기선 과연 정말로 <code class=\"language-text\">[weak self]</code> 약한 참조가 필요할까요?</p>\n<p>1번 예제는 [weak self]를 사용할 필요가 없습니다.</p>\n<p>map의 signature를 보며 이해해봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">/// Returns an array containing the results of mapping the given closure</span>\n<span class=\"token comment\">/// over the sequence's elements.</span>\n<span class=\"token comment\">///</span>\n<span class=\"token comment\">/// In this example, `map` is used first to convert the names in the array</span>\n<span class=\"token comment\">/// to lowercase strings and then to count their characters.</span>\n<span class=\"token comment\">///</span>\n<span class=\"token comment\">///     let cast = [\"Vivien\", \"Marlon\", \"Kim\", \"Karl\"]</span>\n<span class=\"token comment\">///     let lowercaseNames = cast.map { $0.lowercased() }</span>\n<span class=\"token comment\">///     // 'lowercaseNames' == [\"vivien\", \"marlon\", \"kim\", \"karl\"]</span>\n<span class=\"token comment\">///     let letterCounts = cast.map { $0.count }</span>\n<span class=\"token comment\">///     // 'letterCounts' == [6, 6, 3, 4]</span>\n<span class=\"token comment\">///</span>\n<span class=\"token comment\">/// - Parameter transform: A mapping closure. `transform` accepts an</span>\n<span class=\"token comment\">///   element of this sequence as its parameter and returns a transformed</span>\n<span class=\"token comment\">///   value of the same or of a different type.</span>\n<span class=\"token comment\">/// - Returns: An array containing the transformed elements of this</span>\n<span class=\"token comment\">///   sequence.</span>\n@inlinable <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token builtin\">map</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> transform<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Element</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> T<span class=\"token punctuation\">)</span> <span class=\"token keyword\">rethrows</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span></code></pre></div>\n<p>map의 인자로 전달한 클로져는 @escaping 속성을 가지고 있지 않습니다.</p>\n<p>우리가 <code class=\"language-text\">[weak self]</code>를 사용할지 말지 선택할 필요가 있을 때마다 이를 알아차리는 것이 매우 중요합니다.</p>\n<blockquote>\n<p>escaping 클로져에 대해 알아보고 싶으시다면 해당 링크를 참조해주세요!<br>\n링크 : <a href=\"https://hcn1519.github.io/articles/2017-09/swift_escaping_closure\">https://hcn1519.github.io/articles/2017-09/swift<em>escaping</em>closure</a></p>\n</blockquote>\n<p>클로져가 Escaping 클로져가 아니라면,</p>\n<p>컴파일러는 method가 종료되고 나서 해당 클로져가 사용되지 않는다는 것을 확인합니다.</p>\n<p>이 말인즉슨 map이 종료된 후, 다시 map을 호출한 곳으로 돌아오면 인자로 전달한 클로져는 더 이상 메모리에 올라가 있지 않을 것이라는 것을 의미합니다.</p>\n<p>따라서 Escaping 클로져를 다루지 않을 때는, [weak self]를 이용해 약한 참조를 쓸 필요가 없습니다.</p>\n<p>왜냐하면 non escaping closure에서는 Retain Cycle(순환 참조)를 만들 수 없기 때문입니다.</p>\n<p>이를 Swift 컴파일러 또한 알고 있기 때문에 다음과 같이 코드를 변경해도 컴파일러는 Retain Cycle이 생성될 위험이 없다는 것을 알기 때문에 경고를 내지 않습니다.</p>\n<p>따라서 Swift 5.3 버전 이상부터 사용 가능한 Implicit strong capture를 사용해</p>\n<p>self를 명시적으로 캡쳐할 필요가 없습니다.</p>\n<blockquote>\n<p>Implicit Strong Capture는</p>\n<ol>\n<li>사용자가 이미 의도를 명시했거나,</li>\n<li>Strong reference cycle이 발생할 가능성이 없는 상황에서만 사용 가능합니다.</li>\n</ol>\n</blockquote>\n<p><strong>Swift 5.3 Implicit Strong Capture 링크</strong> :<a href=\"https://github.com/apple/swift-evolution/blob/main/proposals/0269-implicit-self-explicit-capture.md\">https://github.com/apple/swift-evolution/blob/main/proposals/0269-implicit-self-explicit-capture.md</a></p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">func</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> value<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">String</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* some logic here... */</span> <span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">func</span> <span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">// 1st example</span>\n\t\t<span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">map</span> <span class=\"token punctuation\">{</span> value <span class=\"token keyword\">in</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>따라서 1번 예제는 <code class=\"language-text\">[weak self]</code>를 사용하지 않아도 됩니다.</p>\n<p>자 이제 뭉친 어깨도 좀 풀어주시고..(먼 산..)</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 300px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 72.39263803680981%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAwAC/8QAFgEBAQEAAAAAAAAAAAAAAAAAAgAB/9oADAMBAAIQAxAAAAEtmtg2Jn//xAAZEAEAAwEBAAAAAAAAAAAAAAABAAIRAxL/2gAIAQEAAQUC2zNZZd5Hu9+ZVHZ//8QAFhEBAQEAAAAAAAAAAAAAAAAAABFB/9oACAEDAQE/AcV//8QAFhEBAQEAAAAAAAAAAAAAAAAAABFB/9oACAECAQE/AdR//8QAHRAAAQMFAQAAAAAAAAAAAAAAAQAQIQIRMTJxsf/aAAgBAQAGPwKaoW8dWbsSPG//xAAbEAEAAgMBAQAAAAAAAAAAAAABABEhMUFxsf/aAAgBAQABPyHVU2cyrATm9J9bIGTBSSh7xtKlp1n/2gAMAwEAAgADAAAAEAsP/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAERITH/2gAIAQMBAT8QjA7H/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERIf/aAAgBAgEBPxDKgkh//8QAHRABAAMAAQUAAAAAAAAAAAAAAQARIWExQVFxkf/aAAgBAQABPxDGC3ZS/BBR3ifNuwwL4NM9RkaWAbxKkIHQWDm5ZkFwDDWf/9k=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"2\" title=\"2\" src=\"/static/fc86ad074d035ddad94883721c137abb/f93b5/2.jpg\" srcset=\"/static/fc86ad074d035ddad94883721c137abb/d2f63/2.jpg 163w,\n/static/fc86ad074d035ddad94883721c137abb/f93b5/2.jpg 300w\" sizes=\"(max-width: 300px) 100vw, 300px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n</p>\n<h2 id=\"2번-예제를-봅시다\" style=\"position:relative;\"><a href=\"#2%EB%B2%88-%EC%98%88%EC%A0%9C%EB%A5%BC-%EB%B4%85%EC%8B%9C%EB%8B%A4\" aria-label=\"2번 예제를 봅시다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2번 예제를 봅시다.</h2>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> value<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">String</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 2nd example</span>\n        <span class=\"token builtin\">DispatchQueue</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">asyncAfter</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Any</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>첫 번째 예제와 같은 방식으로 <code class=\"language-text\">DispatchQueue.main.asyncAfter(deadline:execute:)</code> 의</p>\n<p>Signature를 살펴보는 방식으로 접근해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\">\t\t<span class=\"token comment\">///</span>\n    <span class=\"token comment\">/// Submits a work item to a dispatch queue for asynchronous execution after</span>\n    <span class=\"token comment\">/// a specified time.</span>\n    <span class=\"token comment\">///</span>\n    <span class=\"token comment\">/// - parameter: deadline the time after which the work item should be executed,</span>\n    <span class=\"token comment\">/// given as a `DispatchTime`.</span>\n    <span class=\"token comment\">/// - parameter qos: the QoS at which the work item should be executed.</span>\n    <span class=\"token comment\">///\tDefaults to `DispatchQoS.unspecified`.</span>\n    <span class=\"token comment\">/// - parameter flags: flags that control the execution environment of the</span>\n    <span class=\"token comment\">/// work item.</span>\n    <span class=\"token comment\">/// - parameter execute: The work item to be invoked on the queue.</span>\n    <span class=\"token comment\">/// - SeeAlso: `async(execute:)`</span>\n    <span class=\"token comment\">/// - SeeAlso: `asyncAfter(deadline:execute:)`</span>\n    <span class=\"token comment\">/// - SeeAlso: `DispatchQoS`</span>\n    <span class=\"token comment\">/// - SeeAlso: `DispatchWorkItemFlags`</span>\n    <span class=\"token comment\">/// - SeeAlso: `DispatchTime`</span>\n    <span class=\"token comment\">///</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function\">asyncAfter</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">:</span> <span class=\"token builtin\">DispatchTime</span><span class=\"token punctuation\">,</span> qos<span class=\"token punctuation\">:</span> <span class=\"token builtin\">DispatchQoS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>unspecified<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">:</span> <span class=\"token builtin\">DispatchWorkItemFlags</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> execute work<span class=\"token punctuation\">:</span> @escaping @<span class=\"token function\">convention</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>이번에는 클로져가 인자로써 @escaping 클로져(execute work: @escaping @convention(block) () -> Void))로 전달됩니다.</p>\n<p>이런 경우를 주의해야 하는데요,</p>\n<p>Escaping 클로져는 클로져가 해당 메소드가 종료된 이후에도 메모리에 남아 있을 수 있다는 것을 의미합니다.</p>\n<blockquote>\n<p>또한, 이 클로져가 메모리에 얼마나 남아있을지는 모릅니다.</p>\n</blockquote>\n<p>Escaping 클로져에서는 다음 두 가지 상황을 만족할 때 <code class=\"language-text\">[weak self]</code>를 사용하지 않는다면<br>\nRetain Cycle(순환 참조) 이 생길 수 있습니다.</p>\n<ol>\n<li>클로져가 객체의 property에 저장되거나 다른 클로저로 전달될 경우</li>\n<li>클로져 안에 있는 객체가 클로져(해당 클로져 혹은 전달 받은 클로져)에 대한 강한 참조를 유지하는 경우</li>\n</ol>\n<p>코드를 다시 봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> value<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">String</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* some logic here... */</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 2nd example</span>\n        <span class=\"token builtin\">DispatchQueue</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">asyncAfter</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Any</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그렇다면 이 친구는 @escaping 클로져로 전달되는 클로져니 <code class=\"language-text\">[weak self]</code> 를 이용해 약한 참조를 해주어야 할까요?</p>\n<p><strong>정답부터 말하자면 아닙니다.</strong></p>\n<p>엥…</p>\n<p>이유를 살펴봅시다!</p>\n<p><code class=\"language-text\">DispatchQueue.main.asyncAfter(deadline: .now() + 2)</code>를 이용해</p>\n<p>현재 시각으로부터 2초 후에 인자로 전달한 클로져를 실행하도록 하였습니다.</p>\n<p>이 상황에서 이 클로져는 2초 동안 메모리에 유지됩니다.</p>\n<p>이는 위의 인자로 전달한 클로져에서 <code class=\"language-text\">[weak self]</code>를 지울 수 있다는 것을 의미합니다.</p>\n<p>Closure의 실행이 끝난 후에 Closure가 메모리에서 제거되기 때문에 Retain Cycle(참조 사이클)을 생성하지 않습니다.</p>\n<p><strong>따라서 이 상황에서는 Strong Capture가 가능합니다.</strong></p>\n<p>이는 GCD와 관련이 있는데요, 이와 관련한 좋은 포스트가 있어 공유해 드립니다.</p>\n<p>링크 : <a href=\"https://medium.com/rocknnull/ios-gcd-what-the-weak-is-going-on-d5a10fc682a\">iOS - GCD what the __weak is going on?</a></p>\n<p>링크 : <a href=\"https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html#//apple_ref/doc/uid/TP40008091-CH102-SW11\">Dispatch Queues</a></p>\n<p>GCD호출은 나중에 실행하기 위해 속성(property)에 저장하지 않는 한 retain cycle(순환 참조)의 위험이 없습니다.</p>\n<p>또한 GCD와 마찬가지로 <strong><code class=\"language-text\">UIView.Animate</code> , <code class=\"language-text\">UIViewPropertyAnimator</code></strong> 와 같은 animation call 역시</p>\n<p>속성(property)에 저장하지 않는 한 retain cycle(순환 참조)의 위험이 없습니다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 300px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 85.88957055214723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAAErUlEQVQ4yxWU2U/UBxDH96lvtTVWjcq17AUs7AV7ALucKyAsd4V1dV3kEOQGgerCKpcgCMjhwsp9iUCsqNSK1Xqg1kYT05o+NGlNTR9qH9qHpn/Ap78+TDLJZL75zHwzI1q+0sbZ8lyWZr0MX+kl3ZZAX9dRWktSyTQpKCtMo6Ysmy5PDSeP5eGuL6HYVUDT0UNszAzw9rmbu20Otr9ZYK2tE9Gjh/eotKczPXGZyelRbIJgtyeHekc8OeZQyu2pJFs0iIMCCA7cR1yMlhyblVZnBneve3nzsIqV04W8erLGqvs8oqkhD0XpiQyNDDG76MNqNdHfnk+dI4EMUwh5GVYM+kikkmAhAtm161NMUWH0n7LzcHOOp6vHmG04wpvtNa43eRBd8RyhtSiNscELTM/0UZiXRL8njy9cibjSDSSaY9HoIlGpIpBJxRzYv5dYg4qRlnJuLfewNVfMwhkn23dGma45hairLIue0hwunMyhtzKfvqrD9Ffk0nnCxmitg6ZSO/FxFsJCFSjkYgLF/jjTzXjrChiqzmasLpeR2jxG6vIZqMpCFBm0n6jgfRgVfsRFBJOklmIJE2MODcQWpWSyuwlPRSEum5kTOYlkxxswy4IwS/2IlR4gRnIAi9wfc0gAqWoZovCA3YTL92AIP4BWvhup/yfIgnYiDdiBxRjObW8HC90NdFQ6aHYcIjdBj04pITJCglIQUoUGERywh892foRRyEVpegVWwc3i/ChsVjXHhaY0azRGYyzucwM8XR9ntbuRsYYi+mqOY7VYiTHEUuI8jLvJRVdrCc7PreiVfph0oYgyo1Ukm5W4ctSUFxdQVlGP0ZyJOjKV6uaL9LtraMk9SEVGDJ66SkpdtQT5haAMiSI5wUx9jR1noY30uDDiDRECYbRGcDKMxtJEge4IUSYbal08UYYU4g8WUl3dSn2Rg5bSAiprz5KcaEOp0AkRiUwswKRlkeNyk2QxEqNXIkrUKDAbJUz0ldN0+jRiWTRKlZkovRW5wkDDmRG+ffGO1RuPcZa0EOSvQBWmJzREi0yiQq83kZ1vIyXJgFGnQpSskRNnEOOuzicr6zAatRlVuJGgYA0ymRadLhnf9D0WFu+jVkUTIlURrtAilyiFyxFGV+pISUvAYlKijQhHlK6VCotWUF/lRB+XhT0jk2pHAdrYZCTh0fhLNRwsOEVGqZsASQRh6hgUgrBUoBTL1USaLBS4CokxadH8L3i+o52OyXm6JxZxD8/R41tmcv0OVweH6ayup7umka5GN30Xhxk810FPWwft9S10CbXOrn6avXO4ffOc9c7g6r2E6MT5AZa2fmBifovx+ftcntjEd+0xj9Zv8fSqj1fXVni5vMCzxTmer6xwe2iU729tcmdokPX5NaZuP2d4aoux2fsMP3iM6ExzI70zS9R2jzK58YDN7de8/vU9P/35B29/+wXv9Ru0j0/TP+7FNzPD2MQEUxtfcvO7l3z96gVjGxs0jfmouDRCuacVkbfOjlkbzMc7duO9PMS/H97x9/uf+fD7j/zz11vu3pzlxtIE91Z9jHlqSTKohV9o44m3ja/6Gnk26cGeEoP/vr1YVDL+A6Qj2al4t9I1AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"3\" title=\"3\" src=\"/static/890d10a3067cd3c416b9351d34e872dd/5a46d/3.png\" srcset=\"/static/890d10a3067cd3c416b9351d34e872dd/222b7/3.png 163w,\n/static/890d10a3067cd3c416b9351d34e872dd/5a46d/3.png 300w\" sizes=\"(max-width: 300px) 100vw, 300px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n</p>\n<p>사실 이런 경우는 좀 <strong>복잡 미묘</strong>할 수 있습니다.</p>\n<p><strong>왜냐하면 <code class=\"language-text\">[weak self]</code>가 없다면 이 코드는 <code class=\"language-text\">[weak self]</code>가 있는 코드와 다르게 동작하기 때문입니다.</strong></p>\n<p>제가 만든 다른 예제 코드를 따라가 보며 왜 그런지 한번 이해해봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">Foundation</span>\n\n<span class=\"token comment\">// ----- View Model -----</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> value<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">String</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">DispatchQueue</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">asyncAfter</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Any</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">deinit</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"view Model deinit\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ----- View Controller -----</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">let</span> viewModel<span class=\"token punctuation\">:</span> <span class=\"token builtin\">ViewModel</span>\n\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        viewModel <span class=\"token operator\">=</span> <span class=\"token function\">ViewModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">someEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        viewModel<span class=\"token punctuation\">.</span><span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">deinit</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"viewController deinit\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> viewController<span class=\"token punctuation\">:</span> <span class=\"token builtin\">ViewController</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token function\">ViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 1</span>\nviewController<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">someEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 2</span>\nviewController <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span> <span class=\"token comment\">// 3</span></code></pre></div>\n<p>위의 코드의 결과는 어떻게 될까요?</p>\n<h3 id=\"먼저-code-classlanguage-textweak-selfcode-를-이용하는-경우를-보도록-하겠습니다\" style=\"position:relative;\"><a href=\"#%EB%A8%BC%EC%A0%80-code-classlanguage-textweak-selfcode-%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%98%EB%8A%94-%EA%B2%BD%EC%9A%B0%EB%A5%BC-%EB%B3%B4%EB%8F%84%EB%A1%9D-%ED%95%98%EA%B2%A0%EC%8A%B5%EB%8B%88%EB%8B%A4\" aria-label=\"먼저 code classlanguage textweak selfcode 를 이용하는 경우를 보도록 하겠습니다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>먼저 <code class=\"language-text\">[weak self]</code> 를 이용하는 경우를 보도록 하겠습니다.</h3>\n<blockquote>\n<p>주석에 있는 숫자를 편의상 1번 라인, 2번 라인, 3번 라인이라고 부르겠습니다.</p>\n</blockquote>\n<p>1번 라인에서 ViewController가 생성되며 viewModel속성이 ViewModel 인스턴스로 초기화됩니다.</p>\n<p>2번 라인에서 <code class=\"language-text\">someEvent()</code> 메소드가 호출되어 ViewModel 인스턴스의 code가 호출될 것입니다.</p>\n<p>2번 라인에서 호출한 메소드 내부에서 호출한 <code class=\"language-text\">code()</code>메소드 내부에서 <code class=\"language-text\">DispatchQueue.main.asyncAfter(deadline:execute:)</code> 의 인자로 전달한 클로져는 2초 후에 실행될 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token builtin\">DispatchQueue</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">asyncAfter</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span>\n\t<span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Any</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>2초가 지나기 전에 3번 라인에서 viewController 인스턴스가 할당 해제된다면 <code class=\"language-text\">ViewController</code> 인스턴스가 소유하고 있는 <code class=\"language-text\">ViewModel</code> 인스턴스는 약한 참조로 참조하고 있어 해제되게 됩니다.</p>\n<p>따라서 2초 후에 실행된 클로져 내부의 self는 nil값을 가지게 됩니다.</p>\n<p>이를 이해를 돕기위해 실제 실행 영상으로 보면 다음과 같습니다.</p>\n<blockquote>\n<p>console을 잘 봐주세요!</p>\n</blockquote>\n<p align=\"center\">\n    <img src=\"/62efe04b2b70b36a101ef9e0708a4554/4.gif\">\n</p>\n<h3 id=\"이번에는-weak-self를-사용하지-않은-경우를-살펴보도록-하겠습니다\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EB%B2%88%EC%97%90%EB%8A%94-weak-self%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%80-%EA%B2%BD%EC%9A%B0%EB%A5%BC-%EC%82%B4%ED%8E%B4%EB%B3%B4%EB%8F%84%EB%A1%9D-%ED%95%98%EA%B2%A0%EC%8A%B5%EB%8B%88%EB%8B%A4\" aria-label=\"이번에는 weak self를 사용하지 않은 경우를 살펴보도록 하겠습니다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>이번에는 [weak self]를 사용하지 않은 경우를 살펴보도록 하겠습니다.</h3>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">Foundation</span>\n\n<span class=\"token comment\">// ----- View Model -----</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> value<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">String</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">DispatchQueue</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">asyncAfter</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Any</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">deinit</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"view Model deinit\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ----- View Controller -----</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">let</span> viewModel<span class=\"token punctuation\">:</span> <span class=\"token builtin\">ViewModel</span>\n\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        viewModel <span class=\"token operator\">=</span> <span class=\"token function\">ViewModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">someEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        viewModel<span class=\"token punctuation\">.</span><span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">deinit</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"viewController deinit\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> viewController<span class=\"token punctuation\">:</span> <span class=\"token builtin\">ViewController</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token function\">ViewController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 1</span>\nviewController<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">someEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 2</span>\nviewController <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span> <span class=\"token comment\">// 3</span></code></pre></div>\n<blockquote>\n<p>코드는 self를 강한 참조를 한 것 말고는 이전과 달라진 게 없습니다!</p>\n</blockquote>\n<p>2번 라인에서 호출한 메소드 내부에서 호출한 <code class=\"language-text\">code()</code>를 호출하게 되면 이번에도 역시 2번 라인에서 호출한 <code class=\"language-text\">code()</code>메소드 내부에서<code class=\"language-text\">DispatchQueue.main.asyncAfter(deadline:execute:)</code> 의 인자로 전달한 클로져는 2초 후에 실행될 것입니다.</p>\n<p>2초가 지나기 전에 3번 라인에서 viewController 인스턴스가 할당 해제된다면 <code class=\"language-text\">ViewController</code> 인스턴스가 소유하고 있는 <code class=\"language-text\">ViewModel</code> 인스턴스가 <strong>이번에는</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token builtin\">DispatchQueue</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">asyncAfter</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Any</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>강한 참조로 참조하고 있어 해제되지 않고 <code class=\"language-text\">self.format(42)</code> 가 원래 의도한 대로 할당되게 됩니다.</p>\n<p>따라서 2초 후에 실행된 클로져 내부의 self는 <code class=\"language-text\">ViewModel</code> 인스턴스를 가리킵니다.</p>\n<p>그리고 GCD 호출은 나중에 실행하기 위해 속성(property)에 저장하지 않는 한</p>\n<p>Retain Cycle(순환 참조)을 유발하지 않기 때문에</p>\n<p><strong>2초가 지난 후에</strong> <code class=\"language-text\">ViewModel</code> 인스턴스는 정상적으로 해제됩니다.</p>\n<h3 id=\"실제-실행-영상을-한번-볼까요🧐\" style=\"position:relative;\"><a href=\"#%EC%8B%A4%EC%A0%9C-%EC%8B%A4%ED%96%89-%EC%98%81%EC%83%81%EC%9D%84-%ED%95%9C%EB%B2%88-%EB%B3%BC%EA%B9%8C%EC%9A%94%F0%9F%A7%90\" aria-label=\"실제 실행 영상을 한번 볼까요🧐 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>실제 실행 영상을 한번 볼까요?🧐</h3>\n<p align=\"center\">\n    <img src=\"/d5ab9b771903833c5af028a6fafb752b/5.gif\">\n</p>\n<p>따라서 <code class=\"language-text\">[weak self]</code> 를 사용하는지 안 하는지에 따라 다른 동작이 발생할 수도 있고, 발생하지 않을 수도 있기 때문에 이러한 부분을 Escaping 클로져를 전달할 때 주의해야합니다.</p>\n<p>또한 이 부분을 통해 <code class=\"language-text\">self</code>의 생명주기를 고려해야 함을 엿볼 수 있었습니다.</p>\n<p>두 번째 예제에서 얻을 수 있는 결론은 <code class=\"language-text\">[weak self]</code> 가 의무적인 것은 아니지만, 사용하거나 사용하지 않을 때에 따라 코드의 동작을 바꿀 수 있기 때문에 우리는 각별히 주의하며 사용해야한다는 것입니다.</p>\n<p>마지막으로 세 번째 예제를 봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> value<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">String</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* some logic here... */</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> handler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 3rd example</span>\n        handler <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> value <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">let</span> formatted <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>formatted <span class=\"token keyword\">as</span> <span class=\"token builtin\">Ant</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>세 번째 예제가 <code class=\"language-text\">[weak self]</code>를 사용해야하는 대표적 예입니다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 33.74233128834356%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABaklEQVQoz12R60/CMBTF978bFRD9ZkJClPhMnBgfiU8Qjc8IBCWoH4gBjYCBrWPtGLix7bheAiacpO1y++tZ76mCUM6vA8YYOOcwDIOG67hyC0EQ0JDyPA+6rkMIQUy324U39CaclCIny7bAdEaQNJbfXHBMa+AMoHU0mF1zwvXs3mRfmiqXlQts3KbwUL2DsAQsYeGlVoJa2MbxyyHEQMAPfOQqGeIeq/fUCTcFyvVnqPmQKx+B90cXUOJ7EUQ357B0sICvn09qJ3G6jMXdGObVGVS+y+iINqLpWcS25rG4H0VTa6A/6CN5kUBcjSCWnkOxlh8ZZl7PkLpO4uo9C53pdMPCxxPWb1ax96TCtMOcfA/nlRPicm9Z2H0bvuejVC9i7WYl5HZg9NjIUIbcbDfIaCyZUavTCn+g0UHHcTDimtSuzF/mxU2OVlhjBps8jjIcDukQrb5PebmuSzUJUc3/r405aTjNSf0BjkoBhW4a9aoAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"1\" title=\"1\" src=\"/static/219f9ed045afd3755a65c5f70333e6f0/a6d36/1.png\" srcset=\"/static/219f9ed045afd3755a65c5f70333e6f0/222b7/1.png 163w,\n/static/219f9ed045afd3755a65c5f70333e6f0/ff46a/1.png 325w,\n/static/219f9ed045afd3755a65c5f70333e6f0/a6d36/1.png 650w,\n/static/219f9ed045afd3755a65c5f70333e6f0/e548f/1.png 975w,\n/static/219f9ed045afd3755a65c5f70333e6f0/3c492/1.png 1300w,\n/static/219f9ed045afd3755a65c5f70333e6f0/fa63f/1.png 2298w\" sizes=\"(max-width: 650px) 100vw, 650px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n</p>\n<p>여기서는 클로져를 ViewModel class 안에 있는 handler에 저장합니다.</p>\n<blockquote>\n<p>Swift는 함수를 일급함수로써 취급하기 때문에 함수를 변수, 상수에 저장이 가능합니다.</p>\n</blockquote>\n<p>만약 이를 <code class=\"language-text\">[weak self]</code>를 이용해 캡쳐하지 않고, self를 캡쳐를 했다면</p>\n<p>클로져에 대한 참조가 handler변수에 의해 붙잡혀있게 되어 클로져는 self 인스턴스가 해제될 때까지 기다리고</p>\n<p>self 인스턴스는 클로져가 해제될 때까지 기다리는 Retain Cycle(순환 참조) 상황을 만들어 내게 됩니다.</p>\n<p>따라서 이러한 상황에서는 <code class=\"language-text\">[weak self]</code>를 이용해 self 인스턴스의 reference count를 증가시키지 않게 하는 것이 Retain Cycle(순환 참조) 를 만들지 않게 할 것입니다.</p>\n<p><strong>마치기 전에</strong> 마지막으로 [weak self]를 사용할 때 <code class=\"language-text\">guard let self = self else { return }</code>로 옵셔널 바인딩하는 방식과 옵셔널 체이닝 방식을 이용하는 방식의 차이를 살펴봅시다.</p>\n<h2 id=\"guard-let-self--self-else--return--vs-selfsome\" style=\"position:relative;\"><a href=\"#guard-let-self--self-else--return--vs-selfsome\" aria-label=\"guard let self  self else  return  vs selfsome permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>guard let self = self else { return } VS self?.some</h2>\n<p>옵셔널 바인딩을 (ex: <code class=\"language-text\">guard let self = self else { return }</code> ) 사용하는 경우 self가 nil이 아닐 경우 self를 임시적으로 강한 참조를 하게 됩니다.</p>\n<p>따라서 self가 해제 되어야 하는 상황에서도 self에 대한 reference count가 증가되었기 때문에</p>\n<p>클로저가 종료될 때까지 self가 살아있게 됩니다.</p>\n<p>반면 옵셔널 체이닝을 사용하는 경우 nil인지 체크를 하게 되고, 가리키는 대상이 nil일 경우에는 nil을 반환하고, 다음 라인으로 넘어갑니다.</p>\n<p>그 말인즉슨 self가 이미 deallocated된 경우에 불필요한 작업을 하지 않을 수 있다는 것입니다.</p>\n<p>따라서 지연된 할당해제(delayed deallocation)가 발생하는 클로저 등에서 불필요한 작업을 하지 않게 만들 수 있어 좋을 것 같습니다.</p>\n<h2 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p>이제 우리가 살펴본 것을 요약해봅시다.</p>\n<h3 id=\"non-escaping-closure\" style=\"position:relative;\"><a href=\"#non-escaping-closure\" aria-label=\"non escaping closure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-escaping closure</h3>\n<p>Non-escaping 클로져는 scope 내에서 실행된다. 즉, 코드를 즉시 실행하고 나중에 저장하거나 실행할 수 없기 때문에 (예: map과 같은 고차 함수)는 Strong reference cycle을 만들어 낼 위험이 없으므로 <strong>weak 또는 unowned를 사용할 필요가 없다.</strong></p>\n<h3 id=\"escaping-closure\" style=\"position:relative;\"><a href=\"#escaping-closure\" aria-label=\"escaping closure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Escaping closure</h3>\n<p>Escaping 클로져는 클로져가 해당 메소드가 종료된 이후에도 메모리에 남아 있을 수 있다는 것을 의미한다.</p>\n<blockquote>\n<p>또한, 이 클로져가 메모리에 얼마나 남아있을지는 모른다.</p>\n</blockquote>\n<p>따라서 Escaping 클로져에서는 다음 두 가지 상황에서 <code class=\"language-text\">[weak self]</code>를 사용하지 않는다면<br>\nRetain Cycle(순환 참조) 이 생길 수 있다.</p>\n<ol>\n<li>클로져가 객체의 property에 저장되거나 다른 클로저로 전달될 경우</li>\n<li>클로져 안에 있는 객체가 클로져(해당 클로져 혹은 전달 받은 클로져)에 대한 강한 참조를 유지하는 경우</li>\n</ol>\n<p>하지만 GCD나 animation call들은 retain cycle을 만들지 않기 때문에 속성에 저장하지 않는 한 retain cycle</p>\n<p>을 만들지 않기 때문에 이 친구들은 <code class=\"language-text\">[weak self]</code>를 사용하지 않아도 된다.</p>\n<h2 id=\"그렇다면\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%A0%87%EB%8B%A4%EB%A9%B4\" aria-label=\"그렇다면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그렇다면</h2>\n<p>초반에 던진 질문인 모든 상황에서 <code class=\"language-text\">[weak self]</code>를 사용해야 할까? 에 대한 답은</p>\n<p><strong>“반드시 모든 상황에서는 아니다”</strong>입니다.</p>\n<p>Escaping 클로져에서는 <code class=\"language-text\">[weak self]</code> 를 이용해 retain cycle을 막는 것이 좋겠지만</p>\n<p>무작정 모든 Escaping 클로져에서 <code class=\"language-text\">[weak self]</code>만 사용하다 보면 원래의 의도와는 다른 호출 결과를 불러올 수 있기에</p>\n<p><code class=\"language-text\">self</code>의 생명 주기와 상황에 따라서 적절히 사용해 주면 좋을 것 같습니다!</p>\n<p>읽어주셔서 감사합니다.</p>\n<p>다들 즐거운 한 주 보내세요 :)</p>\n<p><em>아직 모르는 것이 많고 알아가는 과정입니다. 잘못된 것이 있다면 댓글로 남겨주신다면 감사하겠습니다!</em>\n😊</p>\n<blockquote>\n<p>참고</p>\n<ul>\n<li><a href=\"https://medium.com/@almalehdev/you-dont-always-need-weak-self-a778bec505ef\">You don’t (always) need [weak self]</a></li>\n<li><a href=\"https://medium.com/rocknnull/ios-gcd-what-the-weak-is-going-on-d5a10fc682a#.m70a04j4m\">iOS — GCD what the __weak is going on?</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=0sOrVoLOf7Q\">When do we REALLY need to use [weak self]?</a></li>\n<li><a href=\"https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html#//apple_ref/doc/uid/TP40008091-CH103-SW12\">Apple - Concurrency Programming Guide</a></li>\n</ul>\n</blockquote>\n<blockquote>\n<p>이미지 출처</p>\n<ul>\n<li><a href=\"https://program.imbc.com/challenge\">MBC 무한도전</a></li>\n</ul>\n</blockquote>","frontmatter":{"title":"[weak self] 무조건 사용하는게 맞는걸까? 🤔","date":"April 08, 2022"}}},"pageContext":{"slug":"/Swift/2022-04-08-[weak-self]-무조건-사용하는게-맞는걸까/","previous":{"fields":{"slug":"/Computer Science/2022-03-31-git의-commit-id는-어떻게-생성될까(feat.블록체인-트랜잭션id)/"},"frontmatter":{"title":"Git의 commit id는 어떻게 생성될까?","category":"computer science","draft":false}},"next":null}}}